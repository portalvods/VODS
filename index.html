<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal VOD - Ultra Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        :root { --bg-dark: #090e1a; --card-dark: #111827; --accent: #3b82f6; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: #f3f4f6; margin: 0; overflow-x: hidden; }
        .glass { background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .status-badge { font-size: 10px; font-weight: 800; padding: 4px 12px; border-radius: 20px; text-transform: uppercase; }
        .status-pendente { background: #fef3c7; color: #92400e; }
        .status-analise { background: #dbeafe; color: #1e40af; }
        .status-concluido { background: #dcfce7; color: #166534; }
        .status-rejeitado { background: #fee2e2; color: #991b1b; }
        .input-dark { background: #1f2937; border: 1px solid #374151; color: white; transition: all 0.3s; }
        .input-dark:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); outline: none; }
        .card-animate { animation: fadeInUp 0.4s ease forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .urgente { border: 2px solid #ef4444 !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .swal2-popup { background: #111827 !important; color: #fff !important; border-radius: 24px !important; }
    </style>
</head>
<body class="p-4 md:p-10">

    <script>
        const DATABASE_URL = 'https://vods-23763-default-rtdb.firebaseio.com/pedidos.json';
        const API_KEY_TMDB = '9e64130cb366f23a3398f4f7c8e982c0';
        const ADMIN_PASSWORD = 'vods123@';
        let currentItem = {};
        let searchMode = 'movie';
        let allPedidos = {}; 
    </script>

    <header class="container mx-auto flex flex-col md:flex-row justify-between items-center mb-12 gap-6">
        <div class="text-center md:text-left">
            <h1 class="text-4xl font-black tracking-tighter text-blue-500">PORTAL<span class="text-white">VOD</span></h1>
            <p class="text-slate-500 font-medium italic">Painel de Solicita√ß√µes Profissional</p>
        </div>
        <nav class="flex gap-2 glass p-1.5 rounded-2xl shadow-2xl">
            <button onclick="showPage('cliente')" class="px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-800 transition">In√≠cio</button>
            <button onclick="showPage('status')" class="px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-800 transition">Meus Pedidos</button>
            <button onclick="checkAdminPassword()" class="px-6 py-2.5 rounded-xl text-sm font-bold bg-blue-600 hover:bg-blue-700 transition shadow-lg">Admin</button>
        </nav>
    </header>

    <main id="page-cliente" class="container mx-auto max-w-6xl">
        <div class="glass p-8 rounded-[32px] mb-8 shadow-2xl border-t-4 border-blue-500">
            <div class="mb-6 bg-blue-500/10 p-4 rounded-2xl border border-blue-500/20 text-blue-400 text-sm font-bold">
                <i class="fas fa-bullhorn mr-2"></i> AVISO: Pedidos de conserto s√£o prioridade em nossa fila!
            </div>
            <div class="flex gap-6 mb-8 border-b border-slate-800 pb-4">
                <button onclick="setSearchMode('movie')" id="btn-movie" class="text-blue-500 font-bold border-b-2 border-blue-500 pb-2">Filmes & S√©ries</button>
                <button onclick="setSearchMode('tv')" id="btn-tv" class="text-slate-500 font-bold pb-2">Canais ao Vivo</button>
            </div>
            <div class="relative"><i class="fas fa-search absolute left-5 top-5 text-slate-500"></i>
                <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Pesquisar..." class="w-full input-dark p-5 pl-14 rounded-2xl">
            </div>
        </div>
        <div id="grid-content" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-8"></div>
    </main>

    <main id="page-status" class="container mx-auto max-w-2xl hidden">
        <div class="glass p-10 rounded-[32px]">
            <h2 class="text-3xl font-black mb-8">Status do Pedido</h2>
            <div class="flex gap-3 mb-8">
                <input type="email" id="trackEmail" placeholder="Seu e-mail cadastrado" class="flex-1 input-dark p-4 rounded-2xl">
                <button onclick="trackRequests()" class="bg-blue-600 px-8 rounded-2xl font-bold">Buscar</button>
            </div>
            <div id="track-results" class="space-y-5"></div>
        </div>
    </main>

    <main id="page-admin" class="container mx-auto max-w-7xl hidden">
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="glass p-6 rounded-3xl border-l-4 border-blue-500"><p class="text-slate-400 text-xs font-bold uppercase">Total</p><h3 id="stat-total" class="text-2xl font-black">0</h3></div>
            <div class="glass p-6 rounded-3xl border-l-4 border-yellow-500"><p class="text-slate-400 text-xs font-bold uppercase">An√°lise</p><h3 id="stat-analise" class="text-2xl font-black text-yellow-500">0</h3></div>
            <div class="glass p-6 rounded-3xl border-l-4 border-green-500"><p class="text-slate-400 text-xs font-bold uppercase">Conclu√≠dos</p><h3 id="stat-concluido" class="text-2xl font-black text-green-500">0</h3></div>
            <div class="glass p-6 rounded-3xl border-l-4 border-red-500"><p class="text-slate-400 text-xs font-bold uppercase">Rejeitados</p><h3 id="stat-rejeitado" class="text-2xl font-black text-red-500">0</h3></div>
        </div>

        <div class="grid lg:grid-cols-3 gap-8 mb-8">
            <div class="glass p-6 rounded-[32px] lg:col-span-1">
                <h3 class="font-black mb-4 flex items-center gap-2"><i class="fas fa-trophy text-yellow-500"></i> TOP PEDIDOS</h3>
                <div id="ranking-list" class="space-y-3 text-sm text-slate-300"></div>
            </div>
            <div class="glass p-6 rounded-[32px] lg:col-span-2">
                <div class="flex flex-col md:flex-row gap-4 justify-between items-center mb-6">
                    <div class="flex gap-2">
                        <button onclick="filterAdmin('Tudo')" class="bg-slate-800 px-4 py-2 rounded-xl text-xs font-bold">Tudo</button>
                        <button onclick="filterAdmin('Conserto')" class="bg-red-500/20 text-red-500 px-4 py-2 rounded-xl text-xs font-bold">Consertos</button>
                        <button onclick="filterAdmin('Pendente')" class="bg-yellow-500/20 text-yellow-500 px-4 py-2 rounded-xl text-xs font-bold">Pendentes</button>
                    </div>
                    <input type="text" id="adminSearch" onkeyup="loadAdmin()" placeholder="Buscar por nome ou email..." class="input-dark p-3 rounded-xl text-xs w-full md:w-64">
                </div>
                <div class="flex justify-between items-center">
                    <button onclick="clearFinished()" class="text-red-500 text-[10px] font-black uppercase hover:underline"><i class="fas fa-trash mr-1"></i> Limpar Conclu√≠dos</button>
                    <button onclick="exportToExcel()" class="text-green-500 text-[10px] font-black uppercase hover:underline"><i class="fas fa-file-excel mr-1"></i> Exportar Dados</button>
                </div>
            </div>
        </div>

        <div class="glass rounded-[32px] overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-900/60 text-slate-500 uppercase text-[10px] font-black">
                    <tr><th class="p-6">Conte√∫do / Obs</th><th class="p-6">Solicitante</th><th class="p-6">Status</th><th class="p-6 text-center">A√ß√µes</th></tr>
                </thead>
                <tbody id="admin-table" class="divide-y divide-slate-800"></tbody>
            </table>
        </div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center p-4 z-50 backdrop-blur-xl">
        <div class="glass rounded-[40px] max-w-md w-full p-10">
            <div id="modal-poster" class="w-32 h-44 bg-slate-800 rounded-3xl mb-6 mx-auto overflow-hidden border border-slate-700"></div>
            <h3 class="text-2xl font-black text-center mb-8" id="modalTitle"></h3>
            <div class="space-y-4">
                <input type="text" id="userName" placeholder="Nome" class="w-full input-dark p-4 rounded-2xl">
                <input type="email" id="userEmail" placeholder="E-mail" class="w-full input-dark p-4 rounded-2xl">
                <select id="requestType" class="w-full input-dark p-4 rounded-2xl">
                    <option value="Adi√ß√£o">üé¨ Solicitar Adi√ß√£o</option>
                    <option value="Conserto">üõ†Ô∏è Relatar Problema (Conserto)</option>
                    <option value="Atualiza√ß√£o">üîÑ Solicitar Atualiza√ß√£o</option>
                </select>
                <textarea id="userObs" placeholder="Ex: Sem √°udio no ep 2..." class="w-full input-dark p-4 rounded-2xl h-24"></textarea>
                <button id="btnEnviar" onclick="saveToFirebase()" class="w-full py-5 bg-blue-600 rounded-[24px] font-black shadow-lg hover:bg-blue-700 transition">ENVIAR PEDIDO</button>
                <button onclick="closeModal()" class="w-full text-slate-500 font-bold mt-4">CANCELAR</button>
            </div>
        </div>
    </div>

    <script>
        // --- NAVEGA√á√ÉO E BUSCA ---
        function showPage(page) {
            document.querySelectorAll('main').forEach(m => m.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            if(page === 'admin') loadAdmin();
        }

        function setSearchMode(mode) {
            searchMode = mode;
            document.getElementById('btn-movie').className = mode === 'movie' ? 'text-blue-500 font-bold border-b-2 border-blue-500 pb-2' : 'text-slate-500 font-bold pb-2';
            document.getElementById('btn-tv').className = mode === 'tv' ? 'text-blue-500 font-bold border-b-2 border-blue-500 pb-2' : 'text-slate-500 font-bold pb-2';
        }

        async function searchTMDB() {
            const q = document.getElementById('searchInput').value;
            if(q.length < 3) return;
            const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${API_KEY_TMDB}&language=pt-BR&query=${q}`);
            const data = await res.json();
            renderGrid(data.results.filter(i => i.poster_path).map(i => ({ name: (i.title || i.name).replace(/'/g, ""), img: `https://image.tmdb.org/t/p/w500${i.poster_path}` })));
        }

        function handleSearch() { if (searchMode === 'movie') searchTMDB(); else renderGrid([{ name: `Canal: ${document.getElementById('searchInput').value}`, img: 'https://cdn-icons-png.flaticon.com/512/716/716429.png' }]); }

        function renderGrid(items) {
            const grid = document.getElementById('grid-content');
            grid.innerHTML = items.map((item, idx) => `
                <div class="glass p-4 rounded-[32px] group card-animate" style="animation-delay: ${idx * 0.05}s">
                    <img src="${item.img}" class="w-full h-64 object-cover rounded-2xl mb-4 group-hover:scale-105 transition duration-500">
                    <h4 class="font-bold text-sm truncate text-slate-200 mb-3">${item.name}</h4>
                    <button onclick="openModal('${item.name}', '${item.img}')" class="w-full bg-slate-800 hover:bg-blue-600 py-2 rounded-xl text-[10px] font-black uppercase transition">Solicitar</button>
                </div>`).join('');
        }

        // --- MODAL ---
        function openModal(name, img) {
            currentItem = { name, img };
            document.getElementById('modalTitle').innerText = name;
            document.getElementById('modal-poster').innerHTML = `<img src="${img}" class="w-full h-full object-cover">`;
            document.getElementById('modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        // --- FIREBASE SAVE ---
        async function saveToFirebase() {
            const user = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim().toLowerCase();
            const obs = document.getElementById('userObs').value.trim();
            const type = document.getElementById('requestType').value;
            if(!user || !email) return Swal.fire('Erro', 'Nome e e-mail s√£o obrigat√≥rios!', 'warning');

            const btn = document.getElementById('btnEnviar');
            btn.disabled = true; btn.innerText = "ENVIANDO...";

            const resData = await fetch(DATABASE_URL);
            const data = await resData.json();
            const agora = new Date().getTime();

            if (data) {
                const pedidosEmail = Object.values(data).filter(p => p.email === email);
                if (pedidosEmail.length > 0) {
                    const ultimo = pedidosEmail.sort((a, b) => b.timestamp - a.timestamp)[0];
                    if (agora - ultimo.timestamp < 24 * 60 * 60 * 1000) {
                        btn.disabled = false; btn.innerText = "ENVIAR PEDIDO";
                        return Swal.fire('Limite', 'Voc√™ j√° fez um pedido hoje. Tente amanh√£!', 'error');
                    }
                }
            }

            await fetch(DATABASE_URL, { method: 'POST', body: JSON.stringify({ ...currentItem, user, email, type, obs, status: 'Pendente', date: new Date().toLocaleString('pt-BR'), timestamp: agora }) });
            Swal.fire('Enviado!', 'Sua solicita√ß√£o est√° na fila.', 'success');
            btn.disabled = false; btn.innerText = "ENVIAR PEDIDO";
            closeModal();
        }

        // --- CLIENTE: RASTREIO ---
        async function trackRequests() {
            const email = document.getElementById('trackEmail').value.trim().toLowerCase();
            const res = await fetch(DATABASE_URL);
            const data = await res.json();
            const container = document.getElementById('track-results');
            container.innerHTML = "";
            if(!data) return;
            Object.values(data).reverse().forEach(p => {
                if(p.email === email) {
                    let feedback = p.motivo ? `<button onclick="Swal.fire('Equipe Diz:', '${p.motivo.replace(/'/g, "\\'")}', 'info')" class="text-[10px] text-blue-400 font-bold underline mt-2 block uppercase">Ver Resposta</button>` : '';
                    container.innerHTML += `<div class="glass p-5 rounded-3xl flex items-center gap-5 card-animate"><img src="${p.img}" class="w-14 h-20 rounded-xl object-cover"><div class="flex-1"><b class="text-white">${p.name}</b><br><span class="text-slate-500 text-[10px] uppercase font-bold">${p.type}</span></div><div class="text-right"><span class="status-badge status-${p.status.toLowerCase().replace(/ /g, '').replace('√°','a')}">${p.status}</span>${feedback}</div></div>`;
                }
            });
        }

        // --- ADMIN: L√ìGICA ---
        let currentFilter = 'Tudo';
        function filterAdmin(tipo) { currentFilter = tipo; loadAdmin(); }

        async function loadAdmin() {
            const res = await fetch(DATABASE_URL);
            const data = await res.json();
            allPedidos = data || {};
            const table = document.getElementById('admin-table');
            const search = document.getElementById('adminSearch').value.toLowerCase();
            table.innerHTML = "";
            
            let stats = { total: 0, analise: 0, concluido: 0, rejeitado: 0 };
            let countMap = {};

            if(!data) return updateStats(stats);

            Object.keys(data).reverse().forEach(id => {
                const p = data[id];
                stats.total++;
                if(p.status === 'Em An√°lise') stats.analise++;
                if(p.status === 'Conclu√≠do') stats.concluido++;
                if(p.status === 'Rejeitado') stats.rejeitado++;

                // Ranking logic
                countMap[p.name] = (countMap[p.name] || 0) + 1;

                // Filtros
                if(currentFilter !== 'Tudo' && currentFilter === 'Conserto' && p.type !== 'Conserto') return;
                if(currentFilter !== 'Tudo' && currentFilter === 'Pendente' && p.status !== 'Pendente') return;
                if(search && !p.name.toLowerCase().includes(search) && !p.email.toLowerCase().includes(search)) return;

                const isUrgente = p.type === 'Conserto' ? 'urgente' : '';
                const obsBtn = p.obs ? `<button onclick="Swal.fire('Observa√ß√£o', '${p.obs.replace(/'/g, "\\'")}', 'info')" class="text-yellow-500 ml-2 hover:scale-110"><i class="fas fa-comment-dots"></i></button>` : '';

                table.innerHTML += `
                    <tr class="hover:bg-white/5 transition">
                        <td class="p-6 flex gap-4 items-center">
                            <img src="${p.img}" class="w-12 h-16 rounded-xl object-cover ${isUrgente}">
                            <div>
                                <p class="font-bold text-sm text-white">${p.name}</p>
                                <span class="text-[9px] ${p.type === 'Conserto' ? 'text-red-500' : 'text-blue-500'} font-black uppercase">${p.type}</span>
                                ${p.obs ? `<p class="text-[9px] text-slate-500 truncate w-32 italic">${p.obs}</p>` : ''}
                            </div>
                        </td>
                        <td class="p-6 text-xs text-slate-400"><b>${p.user}</b><br>${p.email}</td>
                        <td class="p-6"><span class="status-badge status-${p.status.toLowerCase().replace(/ /g, '').replace('√°','a')}">${p.status}</span></td>
                        <td class="p-6 text-center flex items-center justify-center">
                            <select onchange="handleStatusChange('${id}', this.value)" class="text-[10px] p-2 bg-slate-800 rounded-xl outline-none mr-2">
                                <option value="Pendente" ${p.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                <option value="Em An√°lise" ${p.status === 'Em An√°lise' ? 'selected' : ''}>An√°lise</option>
                                <option value="Conclu√≠do" ${p.status === 'Conclu√≠do' ? 'selected' : ''}>Conclu√≠do</option>
                                <option value="Rejeitado" ${p.status === 'Rejeitado' ? 'selected' : ''}>Rejeitado</option>
                            </select>
                            ${obsBtn}
                            <button onclick="deletePedido('${id}')" class="text-slate-500 hover:text-red-500 transition ml-2"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>`;
            });
            updateStats(stats);
            renderRanking(countMap);
        }

        function updateStats(s) {
            document.getElementById('stat-total').innerText = s.total;
            document.getElementById('stat-analise').innerText = s.analise;
            document.getElementById('stat-concluido').innerText = s.concluido;
            document.getElementById('stat-rejeitado').innerText = s.rejeitado;
        }

        function renderRanking(map) {
            const sorted = Object.entries(map).sort((a,b) => b[1] - a[1]).slice(0, 5);
            document.getElementById('ranking-list').innerHTML = sorted.map(([name, count], i) => `
                <div class="flex justify-between items-center bg-white/5 p-2 rounded-lg border border-white/5">
                    <span>${i+1}. ${name}</span>
                    <span class="bg-blue-600 px-2 rounded text-[10px] font-black">${count}x</span>
                </div>`).join('') || 'Sem dados ainda...';
        }

        async function handleStatusChange(id, newStatus) {
            const { value: resp } = await Swal.fire({ title: 'Resposta ao Cliente', input: 'textarea', inputPlaceholder: 'Escreva sua mensagem personalizada...', showCancelButton: true });
            if (resp === undefined) { loadAdmin(); return; }
            const motivo = resp || (newStatus === 'Conclu√≠do' ? "Pedido atendido!" : "Pedido rejeitado.");
            await fetch(DATABASE_URL.replace('.json', `/${id}.json`), { method: 'PATCH', body: JSON.stringify({ status: newStatus, motivo: motivo }) });
            loadAdmin();
        }

        async function deletePedido(id) {
            const r = await Swal.fire({ title: 'Excluir?', icon: 'warning', showCancelButton: true });
            if (r.isConfirmed) { await fetch(DATABASE_URL.replace('.json', `/${id}.json`), { method: 'DELETE' }); loadAdmin(); }
        }

        async function clearFinished() {
            const r = await Swal.fire({ title: 'Limpar Conclu√≠dos?', text: 'Isso apagar√° todos do Firebase!', icon: 'warning', showCancelButton: true });
            if (r.isConfirmed) {
                for(let id in allPedidos) if(allPedidos[id].status === 'Conclu√≠do') await fetch(DATABASE_URL.replace('.json', `/${id}.json`), { method: 'DELETE' });
                loadAdmin();
            }
        }

        function exportToExcel() {
            let csv = "Nome;Email;Conteudo;Tipo;Status;Data\n";
            Object.values(allPedidos).forEach(p => { csv += `${p.user};${p.email};${p.name};${p.type};${p.status};${p.date}\n`; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pedidos_vod.csv'; a.click();
        }

        function checkAdminPassword() {
            Swal.fire({ title: 'Acesso Restrito', input: 'password', showCancelButton: true }).then((r) => { if(r.value === ADMIN_PASSWORD) showPage('admin'); });
        }
    </script>
</body>
</html>